# Detection Lab

# Purpose
This lab has been designed with defenders in mind. Its primary purpose is to simulate a Windows domain that comes pre-loaded with security tooling and some best practices when it comes to system logging configurations. It can easily be expanded to include additional OSX and Linux hosts.

Potential use cases:
* Determining which log and forensic artifacts are generated by an attack tool
* Using the lab as a staging environment to test security or logging tool configuration changes before deploying to production
* Use the lab as an environment to test new security tooling

NOTE: This lab has not been hardened in any way and runs with default vagrant credentials. Please do not connect or bridge it to any networks you care about.

# Requirements
* 50GB+ of free disk space
* Packer 1.0.0 or newer
* Vagrant 1.9.2 or newer
* VMWare Fusion/Workstation or Virtualbox

This lab has been successfully tested on:

OS | Vagrant | Packer | Provider
---|---------|--------|-----------
OSX 10.12.4 | 1.9.3 | 1.0.0 | Virtualbox (5.1.14)
OSX 12.12.4 | 1.9.2 | 1.0.0 | VMWare Fusion (8.5.6)

# Quickstart
1. Determine which Vagrant provider you want to use. Note: Virtualbox is free, the [VMWare vagrant plugin](https://www.vagrantup.com/vmware/#buy-now) is $80 per seat.
2. Open the Packer directory and build the Windows 10 and Windows Server 2016 boxes:

  ```packer build --only=<vmware|virtualbox>-iso windows_10.json
packer build --only=<vmware|virtualbox>-iso windows_2016.json```

3. Move the resulting boxes (.box files) in the Packer folder to the Boxes folder:

  ```mv *.box ../Boxes```

4. Navigate to http://127.0.0.1:8000 in a browser to access the Splunk instance on logger. Default credentials are admin:changeme (you will have the option to change them on the next screen)

5. Inside of the *Vagrant* folder, run `vagrant up`. This command will do the following:
  1. Provision the DC host and configure it as a Domain Controller
  2. Provision the WEF host and configure it as a Windows Event Collector in the Servers OU
  3. Provision the Win10 host and configure it as a computer in the Workstations OU
  4. Provision the logger host and configure a fully featured Splunk instance on it

## Lab Hosts
* DC - Windows 2016 Domain Controller
  * WEF Server Configuration GPO
  * Powershell logging GPO
  * Enhanced Windows Auditing policy GPO
  * Sysmon
  * Osquery
  * Splunk Universal Forwarder (Forwards Sysmon/Osquery)
  * Sysinternals Tools
* WEF - Windows 2016 Server
  * Windows Event Collector
  * Windows Event Subscription Creation
  * Powershell transcription logging share
  * Sysmon
  * Osquery
  * Splunk Universal Forwarder (Forwards WinEventLog/Powershell/Sysmon/Osquery)
  * Sysinternals tools
* Win10 - Windows 10 Workstation
  * Simulates employee workstation
  * Sysmon
  * Osquery
  * Splunk Universal Forwarder (Forwards Sysmon/Osquery)
  * Sysinternals Tools
* Logger - Ubuntu 16.04
  * Splunk Enterprise
    * index = wineventlog -- contains Windows Event Logs
    * index = sysmon -- contains Sysmon logs
    * index = osquery -- contains osquery result logs
    * index = osquery-status -- contains osquery INFO/WARN/ERROR logs
    * index = powershell -- contains powershell transcription logs

## Installed Tools
* Sysmon
* Osquery
* AutorunsToWinEventLog
* Process Monitor
* Process Explorer
* PsExec
* TCPView

# Credits/Resources
* A huge percentage of this code was borrowed from Stefan Scherer's [packer-windows](https://github.com/StefanScherer/packer-windows) and [adfs2](https://github.com/StefanScherer/adfs2) Github repos.

* [Configure Event Log Forwarding in Windows Server 2012 R2](https://www.petri.com/configure-event-log-forwarding-windows-server-2012-r2)
* [Use Windows Event Forwarding to help with intrusion detection](https://technet.microsoft.com/en-us/itpro/windows/keep-secure/use-windows-event-forwarding-to-assist-in-instrusion-detection)
* [PowerShell â™¥ the Blue Team](https://blogs.msdn.microsoft.com/powershell/2015/06/09/powershell-the-blue-team/)
* [Autoruns](https://www.microsoftpressstore.com/articles/article.aspx?p=2762082)
* [TA-microsoft-sysmon](https://github.com/splunk/TA-microsoft-sysmon)
* [osquery](https://osquery.io/)
* [SwiftOnSecurity - Sysmon Config](https://github.com/SwiftOnSecurity/sysmon-config)
* [Packer stuck at: "Gracefully halting virtual machine" after Windows sysprep](https://github.com/hashicorp/packer/issues/4134)
